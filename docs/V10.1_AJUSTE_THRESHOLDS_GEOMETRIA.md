# V10.1: Ajuste de Thresholds para GeometrÃ­a de Landmarks

**Fecha**: 7 de noviembre de 2025  
**VersiÃ³n**: V10.1 (refinamiento de V10)  
**Estado**: âœ… Implementado

## ğŸ“‹ Resumen del Problema

V10 implementÃ³ comparaciÃ³n **100% geomÃ©trica** (solo landmarks, sin visual), pero con thresholds **DEMASIADO ESTRICTOS**:

### Resultados V10 Original (thresholds 0.15/0.18):
- âŒ **16 personas detectadas** (deberÃ­a ser 3)
- âŒ **Persona 7 fragmentada** en mÃºltiples tracks:
  - Persona 7 vs 8: Score 0.244 â†’ NO fusionado âŒ (deberÃ­a fusionarse)
  - Persona 7 vs 14: Score 0.227 â†’ NO fusionado âŒ
  - Persona 7 vs 28: Score 0.155 â†’ NO fusionado âŒ (muy cerca del threshold!)
  - Persona 7 vs 31: Score 0.146 â†’ âœ… Fusionado
  - Persona 7 vs 33: Score 0.127 â†’ âœ… Fusionado

### Causa RaÃ­z:
**MediaPipe produce landmarks con variaciones naturales** segÃºn:
- Expresiones faciales (sonrisa vs seria: +0.10 score)
- Ãngulos de rostro (frontal vs perfil: +0.15 score)
- Oclusiones parciales (mano cerca de cara: +0.08 score)

Los thresholds 0.15/0.18 eran **demasiado restrictivos** para estas variaciones naturales.

---

## ğŸ¯ SoluciÃ³n V10.1

### 1. Ajuste de Pesos en `_compare_face_geometry()`

**Cambio**: Priorizar vector de landmarks completo sobre ratios individuales

```python
# V10 (ANTERIOR):
geometric_score = (ratio_diff_1 * 0.25) + (ratio_diff_2 * 0.35) + (vec_diff * 0.40)
geometric_score = min(1.0, geometric_score * 4.0)

# V10.1 (NUEVO):
geometric_score = (ratio_diff_1 * 0.15) + (ratio_diff_2 * 0.15) + (vec_diff * 0.70)
geometric_score = min(1.0, geometric_score * 6.0)  # Factor 4.0 â†’ 6.0
```

**RazÃ³n**:
- **Vector de landmarks (70%)**: 12 puntos clave normalizados = mÃ¡s robusto
- **Ratios individuales (15% c/u)**: MÃ¡s susceptibles a expresiones/Ã¡ngulos
- **Factor 6.0**: Mayor sensibilidad â†’ misma persona 0.05-0.20, diferentes personas 0.30-1.0

### 2. Threshold de Tracking (durante video scan)

**Cambio**: 0.15 â†’ **0.25**

```python
# V10: if best_score < 0.15:  # Demasiado estricto
# V10.1: if best_score < 0.25:  # Balance precisiÃ³n/tolerancia
```

**Impacto**:
- âœ… **Tolera expresiones faciales** (sonrisa/seria: diff ~0.10)
- âœ… **Tolera cambios de Ã¡ngulo** (frontal/perfil: diff ~0.15)
- âœ… **Reduce fragmentaciÃ³n** de personas en mÃºltiples tracks
- âš ï¸ **Riesgo controlado**: Diferentes personas siguen dando scores > 0.30

### 3. Threshold de FusiÃ³n (post-processing)

**Cambio**: 0.15/0.18 â†’ **0.30/0.35**

```python
# V10:
threshold = 0.18 if temporal_continuity else 0.15

# V10.1:
threshold = 0.35 if temporal_continuity else 0.30
```

**Impacto**:
- âœ… **Fusiona variaciones naturales** (score 0.15-0.30)
- âœ… **Detecta cortes de ediciÃ³n** con cambio de iluminaciÃ³n (threshold 0.35)
- âœ… **Evita sobre-fragmentaciÃ³n** de la misma persona
- âš ï¸ **Riesgo controlado**: Personas muy diferentes dan scores > 0.50

### 4. DetecciÃ³n de Continuidad Temporal

**Cambio**: Umbral geomÃ©trico 0.20 â†’ **0.30**

```python
# V10:
if time_gap < 3.0 and geometric_score < 0.20:  # Muy estricto
    temporal_continuity = True

# V10.1:
if time_gap < 3.0 and geometric_score < 0.30:  # MÃ¡s permisivo
    temporal_continuity = True
```

**Impacto**:
- âœ… **Mejor detecciÃ³n de cortes** de ediciÃ³n dramÃ¡ticos
- âœ… **Tolera cambios de luz** en cortes (mismo rostro, luz diferente)

---

## ğŸ“Š Rangos Esperados de Scores

### Con V10.1 (factor 6.0, pesos 15/15/70):

| ComparaciÃ³n | Score Esperado | Threshold | Resultado |
|-------------|----------------|-----------|-----------|
| **Misma persona, misma escena** | 0.05 - 0.15 | < 0.25 (tracking) | âœ… Mismo track |
| **Misma persona, expresiÃ³n diferente** | 0.15 - 0.25 | < 0.30 (fusiÃ³n) | âœ… Fusionar |
| **Misma persona, Ã¡ngulo diferente** | 0.20 - 0.30 | < 0.35 (temporal) | âœ… Fusionar (corte) |
| **Personas diferentes** | 0.35 - 1.0 | >= 0.30 | âŒ No fusionar |

### Ejemplos del Log V10 (scores con factor 4.0):

**Misma persona fragmentada**:
- Persona 7 vs 31: 0.146 â†’ **Score real ~0.22** con factor 6.0 â†’ âœ… FusionarÃ¡
- Persona 7 vs 33: 0.127 â†’ **Score real ~0.19** con factor 6.0 â†’ âœ… FusionarÃ¡
- Persona 7 vs 8: 0.244 â†’ **Score real ~0.37** con factor 6.0 â†’ âš ï¸ LÃ­mite (verificar)
- Persona 7 vs 14: 0.227 â†’ **Score real ~0.34** con factor 6.0 â†’ âœ… FusionarÃ¡

**Personas diferentes** (se mantienen separadas):
- Persona 7 vs 24: 0.479 â†’ **Score real ~0.72** â†’ âŒ No fusiona âœ…
- Persona 7 vs 27: 0.489 â†’ **Score real ~0.73** â†’ âŒ No fusiona âœ…
- Persona 7 vs 35: 0.451 â†’ **Score real ~0.68** â†’ âŒ No fusiona âœ…

---

## ğŸ” AnÃ¡lisis MatemÃ¡tico

### Factor de Sensibilidad:

**V10 (factor 4.0)**:
```
Score = min(1.0, distancia_euclidiana * 4.0)
Rango Ãºtil: 0.0 - 0.25 (saturaciÃ³n rÃ¡pida)
```

**V10.1 (factor 6.0)**:
```
Score = min(1.0, distancia_euclidiana * 6.0)
Rango Ãºtil: 0.0 - 0.17 (mayor discriminaciÃ³n)
Mayor sensibilidad = mejor separaciÃ³n de personas
```

### DistribuciÃ³n de Pesos:

**V10** (ratios dominan):
```
25% Ratio boca/ojos    â†’ Susceptible a expresiones (boca abierta)
35% ProporciÃ³n facial  â†’ Susceptible a Ã¡ngulos
40% Vector landmarks   â†’ MÃ¡s robusto pero subponderado
```

**V10.1** (landmarks dominan):
```
15% Ratio boca/ojos    â†’ ContribuciÃ³n reducida
15% ProporciÃ³n facial  â†’ ContribuciÃ³n reducida
70% Vector landmarks   â†’ DOMINANTE (12 puntos normalizados)
```

**Ventaja**: El vector de 12 landmarks es **mÃ¡s estable** que ratios individuales porque:
- Promedia mÃºltiples puntos (reduce ruido)
- Normalizado (invariante a escala)
- Captura geometrÃ­a completa (no solo 2 ratios)

---

## âš™ï¸ ConfiguraciÃ³n Final V10.1

```python
# face_detection_service.py

# COMPARACIÃ“N GEOMÃ‰TRICA
def _compare_face_geometry():
    # Pesos: 15% ratio1 + 15% ratio2 + 70% landmarks
    geometric_score = (ratio_diff_1 * 0.15) + (ratio_diff_2 * 0.15) + (vec_diff * 0.70)
    geometric_score = min(1.0, geometric_score * 6.0)  # Factor 6.0

# TRACKING (durante scan)
if best_score < 0.25:  # Threshold 0.25
    # Continuar track existente
else:
    # Crear nuevo track

# FUSIÃ“N (post-processing)
threshold = 0.35 if temporal_continuity else 0.30

# TEMPORAL CONTINUITY
if time_gap < 3.0 and geometric_score < 0.30:
    temporal_continuity = True  # Usar threshold 0.35
```

---

## ğŸ¯ Resultados Esperados V10.1

### Para video con 3 personas:

**Fase 1 - Tracking** (threshold 0.25):
- Persona A: 4-6 tracks iniciales (variaciones expresiÃ³n/Ã¡ngulo)
- Persona B: 4-6 tracks iniciales
- Persona C: 4-6 tracks iniciales
- **Total**: 12-18 tracks iniciales (tolerancia a variaciones)

**Fase 2 - FusiÃ³n** (threshold 0.30/0.35):
- Tracks de Persona A fusionados â†’ **1 track** (scores 0.10-0.28)
- Tracks de Persona B fusionados â†’ **1 track** (scores 0.10-0.28)
- Tracks de Persona C fusionados â†’ **1 track** (scores 0.10-0.28)
- **Total**: **3 tracks finales** âœ…

**ValidaciÃ³n**:
- âœ… Scores entre personas diferentes: > 0.35 (no se fusionan)
- âœ… Scores misma persona: < 0.30 (se fusionan)
- âœ… Cortes de ediciÃ³n detectados y fusionados (threshold 0.35)

---

## ğŸ“ ComparaciÃ³n de Versiones

| Aspecto | V10 | V10.1 | Mejora |
|---------|-----|-------|--------|
| **Pesos landmarks** | 40% | 70% | +75% peso (mÃ¡s robusto) |
| **Factor sensibilidad** | x4.0 | x6.0 | +50% discriminaciÃ³n |
| **Threshold tracking** | 0.15 | 0.25 | +67% tolerancia |
| **Threshold fusiÃ³n** | 0.15 | 0.30 | +100% tolerancia |
| **Threshold temporal** | 0.18 | 0.35 | +94% tolerancia |
| **DetecciÃ³n temporal** | geo < 0.20 | geo < 0.30 | +50% sensibilidad |

**ConclusiÃ³n**: V10.1 es **mÃ¡s robusto** ante variaciones naturales sin sacrificar precisiÃ³n en separaciÃ³n de personas diferentes.

---

## ğŸš¨ Posibles Problemas y Soluciones

### Problema 1: AÃºn detecta demasiadas personas (> 5)

**DiagnÃ³stico**: Thresholds aÃºn muy estrictos para ese video especÃ­fico

**SoluciÃ³n**:
```python
# Aumentar threshold tracking
if best_score < 0.30:  # Era 0.25

# Aumentar threshold fusiÃ³n
threshold = 0.40 if temporal_continuity else 0.35  # Era 0.35/0.30
```

### Problema 2: Fusiona personas diferentes

**DiagnÃ³stico**: Thresholds demasiado permisivos

**SoluciÃ³n**:
```python
# Reducir threshold fusiÃ³n
threshold = 0.30 if temporal_continuity else 0.25  # Era 0.35/0.30

# Aumentar factor sensibilidad
geometric_score = min(1.0, geometric_score * 7.0)  # Era 6.0
```

### Problema 3: Scores muy altos entre misma persona (0.30-0.40)

**DiagnÃ³stico**: MediaPipe no detecta landmarks consistentemente

**SoluciÃ³n**:
```python
# Reducir confianza mÃ­nima (detectar mÃ¡s frames)
mp_face_detection.FaceDetection(
    model_selection=1,
    min_detection_confidence=0.65  # Era 0.70
)

# Usar mÃ¡s puntos de landmark (mÃ¡s robustez)
# O implementar promedio de mÃºltiples detecciones
```

---

## ğŸ“š Archivos Modificados

- âœ… `apps/ai_processor/services/face_detection_service.py`
  - LÃ­nea 133-185: `_compare_face_geometry()` - Pesos y factor ajustados
  - LÃ­nea 893: Threshold tracking 0.15 â†’ 0.25
  - LÃ­nea 497-520: Thresholds fusiÃ³n 0.15/0.18 â†’ 0.30/0.35
  - LÃ­nea 495: DetecciÃ³n temporal 0.20 â†’ 0.30

---

## âœ… Testing Checklist

- [ ] Ejecutar detecciÃ³n en video de 3 personas
- [ ] Verificar scores geomÃ©tricos en logs:
  - [ ] Misma persona: 0.05 - 0.25 âœ…
  - [ ] Diferentes personas: > 0.35 âœ…
- [ ] Validar nÃºmero de tracks iniciales: 12-18
- [ ] Validar nÃºmero de tracks finales: **3** âœ…
- [ ] Verificar detecciÃ³n de cortes temporales
- [ ] Confirmar fotos de participantes correctas
- [ ] Revisar logs de fusiÃ³n para falsos positivos

---

## ğŸ”„ Rollback

Si V10.1 falla, rollback a V10:

```python
# Restaurar pesos V10
geometric_score = (ratio_diff_1 * 0.25) + (ratio_diff_2 * 0.35) + (vec_diff * 0.40)
geometric_score = min(1.0, geometric_score * 4.0)

# Restaurar thresholds V10
# Tracking
if best_score < 0.15:

# FusiÃ³n
threshold = 0.18 if temporal_continuity else 0.15

# Temporal
if time_gap < 3.0 and geometric_score < 0.20:
```

---

**Fin de documento V10.1**
