<!-- templates/presentations/transcription_detail.html -->
{% extends 'base.html' %}

{% block title %}Transcripción - {{ presentation.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Header -->
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 text-dark mb-2">
                        <i class="fas fa-file-alt me-2"></i>Transcripción
                    </h1>
                    <p class="text-muted mb-0">{{ presentation.title }}</p>
                </div>
                <a href="{% url 'presentations:presentation_detail' presentation.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Volver
                </a>
            </div>
        </div>

        <!-- Información de la Presentación -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Información
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Curso:</strong>
                        <p class="mb-1">{{ presentation.assignment.course.name }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Asignación:</strong>
                        <p class="mb-1">{{ presentation.assignment.title }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Estudiante:</strong>
                        <p class="mb-1">{{ presentation.student.get_full_name|default:presentation.student.username }}</p>
                    </div>
                    
                    {% if presentation.audio_duration %}
                    <div class="mb-3">
                        <strong>Duración:</strong>
                        <p class="mb-1">{{ presentation.audio_duration|floatformat:1 }} segundos</p>
                    </div>
                    {% endif %}
                    
                    {% if presentation.transcription_completed_at %}
                    <div class="mb-3">
                        <strong>Transcripción completada:</strong>
                        <p class="mb-1">{{ presentation.transcription_completed_at|date:"d/m/Y H:i" }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="mb-0">
                        <strong>Estado:</strong>
                        <span class="badge bg-{% if presentation.status == 'GRADED' %}success{% elif presentation.status == 'ANALYZED' %}info{% elif presentation.status == 'PROCESSING' %}warning{% else %}secondary{% endif %}">
                            {{ presentation.get_status_display }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transcripción -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-quote-left me-2"></i>Transcripción del Audio
                    </h5>
                    <div>
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" name="transcribe_real" class="btn btn-sm btn-success me-2" onclick="return confirm('¿Transcribir el audio real del video? Esto puede tomar unos minutos y reemplazará la transcripción actual.')">
                                <i class="fas fa-microphone me-1"></i>Transcribir Audio Real
                            </button>
                        </form>
                        {% if has_transcription %}
                        <button class="btn btn-sm btn-outline-primary" onclick="copyTranscription()">
                            <i class="fas fa-copy me-1"></i>Copiar
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if has_transcription %}
                        {% if formatted_transcription %}
                        <!-- Transcripción con timestamps -->
                        <div class="transcription-container">
                            <h6 class="mb-3">Transcripción con Timestamps:</h6>
                            <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                                <pre id="formatted-transcription" class="mb-0" style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem;">{{ formatted_transcription }}</pre>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Texto completo -->
                        <div class="transcription-full">
                            <h6 class="mb-3">Texto Completo:</h6>
                            <div class="bg-light p-3 rounded">
                                <p id="full-transcription" class="mb-0" style="line-height: 1.6;">{{ presentation.transcription_text }}</p>
                            </div>
                        </div>
                        {% else %}
                        <!-- Solo texto completo -->
                        <div class="bg-light p-3 rounded">
                            <p id="full-transcription" class="mb-0" style="line-height: 1.6;">{{ presentation.transcription_text }}</p>
                        </div>
                        {% endif %}
                        
                        <!-- Estadísticas -->
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
                                    <div class="h4 text-primary mb-1">{{ presentation.transcription_text|length }}</div>
                                    <small class="text-muted">Caracteres</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                                    <div class="h4 text-success mb-1">{{ presentation.transcription_text|wordcount }}</div>
                                    <small class="text-muted">Palabras</small>
                                </div>
                            </div>
                            {% if presentation.transcription_segments %}
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-info bg-opacity-10 rounded">
                                    <div class="h4 text-info mb-1">{{ presentation.transcription_segments|length }}</div>
                                    <small class="text-muted">Segmentos</small>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <i class="fas fa-microphone text-success" style="font-size: 4rem; opacity: 0.7;"></i>
                            </div>
                            <h4 class="text-dark mb-3">¡Transcribe el audio de tu video!</h4>
                            <p class="text-muted mb-4">
                                Usa el botón <strong>"Transcribir Audio Real"</strong> para convertir automáticamente 
                                las palabras de tu video en texto. El sistema utilizará IA para generar una 
                                transcripción completa con timestamps.
                            </p>
                            
                            <div class="alert alert-info d-inline-block">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Tip:</strong> Asegúrate de que tu video tenga audio claro para mejores resultados.
                            </div>
                            
                            {% if presentation.status == 'PROCESSING' %}
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="location.reload()">
                                    <i class="fas fa-sync-alt me-1"></i>Actualizar Estado
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyTranscription() {
    const text = document.getElementById('full-transcription').textContent;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            // Mostrar notificación de éxito
            const toast = document.createElement('div');
            toast.className = 'alert alert-success alert-dismissible fade show';
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <i class="fas fa-check me-2"></i>Transcripción copiada al portapapeles
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }).catch(() => {
            alert('Error al copiar. Selecciona el texto manualmente.');
        });
    } else {
        // Fallback para navegadores antiguos
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Transcripción copiada al portapapeles');
    }
}
</script>
{% endblock %}