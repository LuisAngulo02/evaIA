{% extends "base.html" %}
{% load static %}

{% block title %}Calificar Presentación - {{ presentation.title }}{% endblock %}

{% block extra_css %}
<style>
    .participant-card {
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }
    
    .participant-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .ai-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
    }
    
    .grade-input {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        border: 2px solid #dee2e6;
        border-radius: 8px;
    }
    
    .grade-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-1">
                                <i class="fas fa-users me-2 text-primary"></i>
                                Calificar Participantes
                            </h3>
                            <p class="text-muted mb-0">
                                <strong>Presentación:</strong> {{ presentation.title }} | 
                                <strong>Estudiante:</strong> {{ presentation.student.get_full_name }} |
                                <strong>Asignación:</strong> {{ assignment.title }}
                            </p>
                        </div>
                        <div>
                            <a href="{% url 'presentations:presentation_detail' presentation.id %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                Volver
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Formulario -->
    <form method="post" id="bulkGradingForm">
        {% csrf_token %}
        
        <div class="row">
            {% for participant in participants %}
            <div class="col-lg-6 mb-4">
                <div class="card participant-card h-100">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-user-circle me-2 text-primary"></i>
                                {{ participant.label }}
                            </h5>
                            <span class="ai-badge">
                                <i class="fas fa-robot me-1"></i>
                                IA: {{ participant.ai_grade|floatformat:2 }}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Métricas -->
                        <div class="row mb-3 text-center small">
                            <div class="col-4">
                                <div class="text-muted">Coherencia</div>
                                <div class="fw-bold">{{ participant.coherence_score|floatformat:1 }}%</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted">Tiempo</div>
                                <div class="fw-bold">{{ participant.participation_time|floatformat:0 }}s</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted">Palabras</div>
                                <div class="fw-bold">{{ participant.word_count }}</div>
                            </div>
                        </div>
                        
                        <!-- Feedback de IA (resumido) -->
                        <div class="alert alert-light border-start border-primary border-3 mb-3">
                            <small>
                                <strong><i class="fas fa-comments me-1"></i>Análisis de IA:</strong><br>
                                {{ participant.ai_feedback|truncatewords:30 }}
                            </small>
                        </div>
                        
                        <!-- Transcripción (resumida) -->
                        <div class="mb-3">
                            <small class="text-muted">
                                <strong><i class="fas fa-file-alt me-1"></i>Transcripción:</strong><br>
                                <em>{{ participant.transcription|truncatewords:20 }}</em>
                            </small>
                        </div>
                        
                        <!-- Campo de calificación -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-star me-2 text-warning"></i>
                                Calificación (sobre 20)
                            </label>
                            {{ form|slice:"grade_"|slice:participant.id }}
                            <input type="number" 
                                   name="grade_{{ participant.id }}" 
                                   class="form-control grade-input" 
                                   value="{{ participant.ai_grade|floatformat:1 }}"
                                   min="0" 
                                   max="20" 
                                   step="0.1"
                                   placeholder="0.0">
                        </div>
                        
                        <!-- Campo de comentario -->
                        <div>
                            <label class="form-label">
                                <i class="fas fa-comment-dots me-2"></i>
                                Comentarios adicionales (opcional)
                            </label>
                            <textarea name="feedback_{{ participant.id }}" 
                                      class="form-control" 
                                      rows="2" 
                                      placeholder="Agrega comentarios específicos para este participante...">{{ participant.teacher_feedback }}</textarea>
                        </div>
                        
                        <!-- Ver detalle -->
                        <div class="mt-3">
                            <a href="{% url 'presentations:edit_participant_grade' participant.id %}" 
                               class="btn btn-sm btn-outline-primary w-100">
                                <i class="fas fa-eye me-1"></i>
                                Ver Análisis Completo
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Botones de acción -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-0 text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Nota:</strong> Las calificaciones que edites reemplazarán la evaluación de IA. 
                                    Puedes dejar las que prefieras sin modificar.
                                </p>
                            </div>
                            <div>
                                <a href="{% url 'presentations:presentation_detail' presentation.id %}" 
                                   class="btn btn-secondary me-2">
                                    <i class="fas fa-times me-2"></i>
                                    Cancelar
                                </a>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-save me-2"></i>
                                    Guardar Todas las Calificaciones
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Auto-guardar en localStorage para no perder cambios
const form = document.getElementById('bulkGradingForm');
const inputs = form.querySelectorAll('input, textarea');

// Cargar valores guardados
inputs.forEach(input => {
    const saved = localStorage.getItem(`grade_${input.name}`);
    if (saved && input.value === input.defaultValue) {
        input.value = saved;
    }
    
    // Guardar al cambiar
    input.addEventListener('change', () => {
        localStorage.setItem(`grade_${input.name}`, input.value);
    });
});

// Limpiar localStorage al enviar
form.addEventListener('submit', () => {
    inputs.forEach(input => {
        localStorage.removeItem(`grade_${input.name}`);
    });
});

// Validar calificaciones antes de enviar
form.addEventListener('submit', function(e) {
    const gradeInputs = form.querySelectorAll('[name^="grade_"]');
    let hasError = false;
    
    gradeInputs.forEach(input => {
        const value = parseFloat(input.value);
        if (value < 0 || value > 20) {
            hasError = true;
            input.classList.add('is-invalid');
        } else {
            input.classList.remove('is-invalid');
        }
    });
    
    if (hasError) {
        e.preventDefault();
        alert('Por favor, verifica que todas las calificaciones estén entre 0 y 20.');
    }
});
</script>
{% endblock %}
