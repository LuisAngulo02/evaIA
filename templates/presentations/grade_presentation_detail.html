{% extends 'base.html' %}

{% block title %}Calificar: {{ presentation.title }}{% endblock %}

{% block content %}
<div class="content-wrapper fade-in">
    <!-- Header -->
    <div class="grading-header mb-5">
        <div class="breadcrumb-section">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb-modern">
                    <li class="breadcrumb-item">
                        <a href="{% url 'presentations:grade_presentations' %}">
                            <i class="fas fa-star me-2"></i>Calificar Presentaciones
                        </a>
                    </li>
                    <li class="breadcrumb-item active">{{ presentation.title|truncatechars:40 }}</li>
                </ol>
            </nav>
        </div>
        
        <div class="header-content">
            <div class="presentation-info">
                <h1 class="presentation-title">{{ presentation.title }}</h1>
                <div class="student-info">
                    <div class="student-avatar">
                        <img src="https://ui-avatars.com/api/?name={{ presentation.student.get_full_name|default:presentation.student.username }}&background=6366f1&color=ffffff" 
                             alt="{{ presentation.student.get_full_name|default:presentation.student.username }}"
                             class="rounded-circle">
                    </div>
                    <div class="student-details">
                        <h5>{{ presentation.student.get_full_name|default:presentation.student.username }}</h5>
                        <p class="text-muted">{{ presentation.assignment.course.code }} - {{ presentation.assignment.course.name }}</p>
                        <div class="submission-info">
                            <span class="badge bg-info">{{ presentation.assignment.title }}</span>
                            <span class="text-muted ms-2">Subido: {{ presentation.uploaded_at|date:"d M Y H:i" }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="assignment-info">
                <div class="assignment-card">
                    <h6><i class="fas fa-clipboard-list me-2"></i>Información de la Asignación</h6>
                    <div class="assignment-details">
                        <div class="detail-row">
                            <span>Puntaje Máximo:</span>
                            <strong>{{ presentation.assignment.max_score }} puntos</strong>
                        </div>
                        <div class="detail-row">
                            <span>Fecha Límite:</span>
                            <strong {% if presentation.is_late %}class="text-danger"{% endif %}>
                                {{ presentation.assignment.due_date|date:"d M Y H:i" }}
                            </strong>
                        </div>
                        <div class="detail-row">
                            <span>Estado:</span>
                            <span class="badge bg-{{ presentation.status|lower == 'analyzed' and 'success' or 'secondary' }}">
                                {{ presentation.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grading-content">
        <!-- Video Player -->
        <div class="video-section">
            {% if presentation.video_file %}
            <div class="video-container-grading">
                <div class="video-header">
                    <h4><i class="fas fa-play-circle me-2"></i>Video de la Presentación</h4>
                    <div class="video-controls">
                        <span class="video-duration">
                            {% if presentation.duration %}{{ presentation.duration }}{% else %}--:--{% endif %}
                        </span>
                        <span class="video-size">{{ presentation.video_file.size|filesizeformat }}</span>
                    </div>
                </div>
                
                <div class="video-wrapper">
                    <video id="presentationVideo" controls class="grading-video">
                        <source src="{{ presentation.video_file.url }}" type="video/mp4">
                        Tu navegador no soporta el elemento video.
                    </video>
                </div>
                
                <div class="video-tools">
                    <button class="video-tool-btn" onclick="skipTime(-10)">
                        <i class="fas fa-backward"></i> -10s
                    </button>
                    <button class="video-tool-btn" onclick="togglePlayPause()">
                        <i class="fas fa-play" id="playPauseIcon"></i>
                    </button>
                    <button class="video-tool-btn" onclick="skipTime(10)">
                        <i class="fas fa-forward"></i> +10s
                    </button>
                    <button class="video-tool-btn" onclick="toggleFullscreen()">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            {% else %}
            <div class="no-video-message">
                <i class="fas fa-video-slash"></i>
                <h5>Video no disponible</h5>
                <p>No se pudo cargar el video de la presentación.</p>
            </div>
            {% endif %}
        </div>

        <!-- AI Analysis Results -->
        {% if presentation.overall_ai_score %}
        <div class="ai-analysis-section">
            <div class="section-header">
                <h4><i class="fas fa-robot me-2"></i>Análisis de Inteligencia Artificial</h4>
                <p class="text-muted">Evaluación automática basada en criterios de presentación</p>
            </div>
            
            <div class="ai-scores">
                {% if presentation.content_score %}
                <div class="score-card content">
                    <div class="score-icon"><i class="fas fa-book"></i></div>
                    <div class="score-value">{{ presentation.content_score }}%</div>
                    <div class="score-label">Contenido</div>
                    <div class="score-description">Relevancia y estructura del tema</div>
                </div>
                {% endif %}
                
                {% if presentation.fluency_score %}
                <div class="score-card fluency">
                    <div class="score-icon"><i class="fas fa-comments"></i></div>
                    <div class="score-value">{{ presentation.fluency_score }}%</div>
                    <div class="score-label">Fluidez</div>
                    <div class="score-description">Claridad y ritmo del discurso</div>
                </div>
                {% endif %}
                
                {% if presentation.body_language_score %}
                <div class="score-card body-language">
                    <div class="score-icon"><i class="fas fa-user"></i></div>
                    <div class="score-value">{{ presentation.body_language_score }}%</div>
                    <div class="score-label">Lenguaje Corporal</div>
                    <div class="score-description">Gestos y expresión corporal</div>
                </div>
                {% endif %}
                
                {% if presentation.voice_score %}
                <div class="score-card voice">
                    <div class="score-icon"><i class="fas fa-microphone"></i></div>
                    <div class="score-value">{{ presentation.voice_score }}%</div>
                    <div class="score-label">Voz y Dicción</div>
                    <div class="score-description">Claridad y proyección vocal</div>
                </div>
                {% endif %}
                
                <div class="score-card overall">
                    <div class="score-icon"><i class="fas fa-trophy"></i></div>
                    <div class="score-value">{{ presentation.overall_ai_score }}%</div>
                    <div class="score-label">Puntuación IA</div>
                    <div class="score-description">Evaluación general automática</div>
                </div>
            </div>
            
            {% if presentation.ai_feedback %}
            <div class="ai-feedback-card">
                <h6><i class="fas fa-lightbulb me-2"></i>Retroalimentación IA</h6>
                <div class="ai-feedback-content">
                    {{ presentation.ai_feedback|linebreaks }}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Grading Form -->
        <div class="grading-form-section">
            <div class="form-header">
                <h4><i class="fas fa-star me-2"></i>Calificación del Docente</h4>
                <p class="text-muted">Proporciona tu evaluación y retroalimentación</p>
            </div>
            
            <form method="post" class="grading-form">
                {% csrf_token %}
                
                <div class="grading-grid">
                    <!-- Score Input -->
                    <div class="score-input-section">
                        <label for="final_score" class="form-label">
                            <i class="fas fa-trophy me-2"></i>Puntuación Final
                        </label>
                        <div class="score-input-container">
                            <input type="number" 
                                   class="form-control score-input" 
                                   id="final_score" 
                                   name="final_score" 
                                   min="0" 
                                   max="{{ presentation.assignment.max_score }}" 
                                   step="0.1"
                                   placeholder="0.0"
                                   value="{{ presentation.final_score|default:'' }}"
                                   required>
                            <span class="score-max">/ {{ presentation.assignment.max_score }}</span>
                        </div>
                        <div class="score-helper">
                            <small class="text-muted">
                                Puntuación de 0 a {{ presentation.assignment.max_score }} puntos
                                {% if presentation.overall_ai_score %}
                                    <br>Sugerencia IA: {{ presentation.overall_ai_score|floatformat:1 }}%
                                {% endif %}
                            </small>
                        </div>
                        
                        <!-- Visual Score Preview -->
                        <div class="score-preview">
                            <div class="score-bar">
                                <div class="score-fill" id="scoreFill"></div>
                            </div>
                            <div class="score-percentage" id="scorePercentage">0%</div>
                        </div>
                    </div>
                    
                    <!-- Feedback Input -->
                    <div class="feedback-section">
                        <label for="teacher_feedback" class="form-label">
                            <i class="fas fa-comment-alt me-2"></i>Retroalimentación
                        </label>
                        <textarea class="form-control feedback-textarea" 
                                  id="teacher_feedback" 
                                  name="teacher_feedback" 
                                  rows="8" 
                                  placeholder="Proporciona comentarios constructivos sobre la presentación...">{{ presentation.teacher_feedback|default:'' }}</textarea>
                        
                        <!-- Feedback Suggestions -->
                        <div class="feedback-suggestions">
                            <h6 class="small fw-bold mb-2">Sugerencias de retroalimentación:</h6>
                            <div class="suggestion-buttons">
                                <button type="button" class="suggestion-btn" onclick="addSuggestion('Excelente organización del contenido y claridad en la exposición.')">
                                    <i class="fas fa-plus"></i> Organización clara
                                </button>
                                <button type="button" class="suggestion-btn" onclick="addSuggestion('Buen dominio del tema, pero podría mejorar la fluidez al hablar.')">
                                    <i class="fas fa-plus"></i> Mejorar fluidez
                                </button>
                                <button type="button" class="suggestion-btn" onclick="addSuggestion('Mantener mejor contacto visual con la audiencia.')">
                                    <i class="fas fa-plus"></i> Contacto visual
                                </button>
                                <button type="button" class="suggestion-btn" onclick="addSuggestion('Incluir más ejemplos prácticos para apoyar los conceptos.')">
                                    <i class="fas fa-plus"></i> Más ejemplos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="form-actions">
                    <a href="{% url 'presentations:grade_presentations' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-star me-2"></i>Guardar Calificación
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.grading-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 2rem;
    color: white;
    margin-bottom: 2rem;
}

.breadcrumb-modern {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 0.75rem 1.25rem;
    margin-bottom: 1.5rem;
}

.breadcrumb-modern .breadcrumb-item a {
    color: white;
    text-decoration: none;
    font-weight: 500;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 2rem;
}

.presentation-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
}

.student-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.student-avatar img {
    width: 60px;
    height: 60px;
}

.student-details h5 {
    color: white;
    margin-bottom: 0.5rem;
}

.assignment-card {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 1.5rem;
    min-width: 300px;
}

.assignment-details {
    margin-top: 1rem;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.grading-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
}

.video-container-grading {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
}

.video-header {
    padding: 1.5rem;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.video-controls {
    display: flex;
    gap: 1rem;
    color: #6c757d;
    font-size: 0.9rem;
}

.grading-video {
    width: 100%;
    height: auto;
    max-height: 500px;
}

.video-tools {
    padding: 1rem;
    background: #f8f9fa;
    display: flex;
    justify-content: center;
    gap: 1rem;
}

.video-tool-btn {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.video-tool-btn:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.ai-analysis-section {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
}

.section-header {
    text-align: center;
    margin-bottom: 2rem;
}

.ai-scores {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.score-card {
    background: #f8f9fa;
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.score-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.score-card.content { border-left-color: #28a745; }
.score-card.fluency { border-left-color: #17a2b8; }
.score-card.body-language { border-left-color: #ffc107; }
.score-card.voice { border-left-color: #dc3545; }
.score-card.overall { 
    border-left-color: #6f42c1;
    background: linear-gradient(135deg, #667eea15, #764ba215);
}

.score-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
}

.score-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.score-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
}

.score-description {
    font-size: 0.85rem;
    color: #6c757d;
}

.ai-feedback-card {
    background: #e3f2fd;
    border-radius: 12px;
    padding: 1.5rem;
    border-left: 4px solid #2196f3;
}

.grading-form-section {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
}

.grading-grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.score-input-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.score-input {
    font-size: 1.5rem;
    font-weight: 700;
    text-align: center;
    max-width: 120px;
}

.score-max {
    font-size: 1.25rem;
    color: #6c757d;
    font-weight: 600;
}

.score-preview {
    margin-top: 1rem;
}

.score-bar {
    width: 100%;
    height: 12px;
    background: #e9ecef;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.score-fill {
    height: 100%;
    background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
    width: 0%;
    transition: width 0.3s ease;
}

.score-percentage {
    text-align: center;
    font-weight: 600;
    color: #495057;
}

.feedback-textarea {
    min-height: 200px;
    resize: vertical;
}

.feedback-suggestions {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
}

.suggestion-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.suggestion-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    padding: 0.25rem 0.75rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.suggestion-btn:hover {
    background: #e9ecef;
}

.form-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 2rem;
    border-top: 2px solid #f8f9fa;
}

.no-video-message {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.no-video-message i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

@media (max-width: 992px) {
    .header-content {
        flex-direction: column;
    }
    
    .grading-grid {
        grid-template-columns: 1fr;
    }
    
    .student-info {
        flex-direction: column;
        text-align: center;
    }
}

@media (max-width: 768px) {
    .ai-scores {
        grid-template-columns: 1fr;
    }
    
    .grading-header {
        padding: 1.5rem;
    }
    
    .presentation-title {
        font-size: 1.5rem;
    }
}
</style>

<script>
// Score input handling
document.addEventListener('DOMContentLoaded', function() {
    const scoreInput = document.getElementById('final_score');
    const scoreFill = document.getElementById('scoreFill');
    const scorePercentage = document.getElementById('scorePercentage');
    const maxScore = {{ presentation.assignment.max_score }};
    
    function updateScorePreview() {
        const value = parseFloat(scoreInput.value) || 0;
        const percentage = Math.min((value / maxScore) * 100, 100);
        
        scoreFill.style.width = percentage + '%';
        scorePercentage.textContent = percentage.toFixed(1) + '%';
        
        // Change color based on score
        if (percentage >= 90) {
            scoreFill.style.background = '#28a745';
        } else if (percentage >= 70) {
            scoreFill.style.background = '#28a745';
        } else if (percentage >= 50) {
            scoreFill.style.background = '#ffc107';
        } else {
            scoreFill.style.background = '#dc3545';
        }
    }
    
    scoreInput.addEventListener('input', updateScorePreview);
    updateScorePreview(); // Initial update
});

// Video controls
function togglePlayPause() {
    const video = document.getElementById('presentationVideo');
    const icon = document.getElementById('playPauseIcon');
    
    if (video.paused) {
        video.play();
        icon.className = 'fas fa-pause';
    } else {
        video.pause();
        icon.className = 'fas fa-play';
    }
}

function skipTime(seconds) {
    const video = document.getElementById('presentationVideo');
    video.currentTime += seconds;
}

function toggleFullscreen() {
    const video = document.getElementById('presentationVideo');
    if (video.requestFullscreen) {
        video.requestFullscreen();
    } else if (video.webkitRequestFullscreen) {
        video.webkitRequestFullscreen();
    } else if (video.msRequestFullscreen) {
        video.msRequestFullscreen();
    }
}

// Feedback suggestions
function addSuggestion(text) {
    const textarea = document.getElementById('teacher_feedback');
    const currentValue = textarea.value;
    
    if (currentValue.trim() === '') {
        textarea.value = text;
    } else {
        textarea.value = currentValue + '\n\n' + text;
    }
    
    textarea.focus();
    textarea.scrollTop = textarea.scrollHeight;
}

// Video event listeners
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('presentationVideo');
    const icon = document.getElementById('playPauseIcon');
    
    if (video) {
        video.addEventListener('play', () => {
            icon.className = 'fas fa-pause';
        });
        
        video.addEventListener('pause', () => {
            icon.className = 'fas fa-play';
        });
        
        video.addEventListener('ended', () => {
            icon.className = 'fas fa-play';
        });
    }
});
</script>

{% endblock %}